### Runbook for `cloud-gov-deploy.sh`

#### Introduction

The script `cloud-gov-deploy.sh` automates the deployment process to the Cloud.gov platform, specifically a Cloud Foundry (CF) environment. The script performs tasks such as preparing environment variables, updating manifest files, and pushing the application with rolling strategy updates. Additionally, it defines network policies for security purposes.

#### Technical Breakdown

- **Manifest Management**:
  - A temporary manifest file (`manifest.tmp`) is created and populated by converting environment variables to uppercase, which are used to fill placeholder variables within the manifest file.
  - The updated manifest is written back to `manifest.yml`, with both the original and new manifest files being printed to the console.
- **Application Push**:
  - The `cf push` command with a `--strategy rolling` option is used to update the application in a way that ensures availability during the deployment process.
- **Network Policies**:
  - Network policies are configured to allow traffic between the application and a Web Application Firewall (WAF) component. The policies are set to use TCP on a defined port number, ensuring that each component communicates properly.

#### Detailed Steps and Considerations

1. **Environment Preparation**:
   - **Uppercase Conversion**: The environment variables are converted to uppercase to standardize their format. This is achieved using the `${CF_SPACE^^}` syntax.
   - **Variable Instantiate**:
     - `CMS_URI_VAR_NAME`: A variable name derived from the uppercase space name.
     - `CMS_URI`: The value is dynamically derived from the variable `"$!CMS_URI_VAR_NAME"`.
     - `CMS_FQDN`: Extracts the fully qualified domain names (FQDNs).
     - `DRUSH_OPTIONS_URI_VAR_NAME`: A variable name derived from the uppercase space name.
     - `DRUSH_OPTIONS_URI`: Similar to `CMS_URI`, the value is dynamically derived.
     - `STATIC_URI_VAR_NAME`: Another variable name derived from the uppercase space name.
     - `STATIC_URI`: Similar to `CMS_URI`, the value is dynamically derived.
     - `STATIC_FQDN`: Extracts the fully qualified domain names (FQDNs).
     

2. **Manifest Substitution**:
   - The `envsubst` command is used to replace placeholders within the `manifest.tmp` file with the dynamic values from environment variables. The resulting manifest is saved to `manifest.yml`.

3. **Application Deployment**:
   - With the `cf push --strategy rolling`, the script ensures a smooth transition during deployment, maintaining service availability by rolling out the new version in stages without downtime.

4. **Network Policy Configuration**:
   - The network policies are configured by adding rules that allow traffic between the application and the WAF. These settings are defined for the specific environment space and are linked to the specified application and WAF names.

5. **Route Configuration Based on Environment**
   - The script maps routes based on whether it is deploying in a production (PROD) or non-production environment. The route mapping ensures that traffic can reach the appropriate application and static site endpoints.

#### Troubleshooting

- **Manifest Replacement Issues**:
  - *Symptom*: Errors while running the script because variables are not being populated correctly in the manifest file.
  - *Solution*: Verify that the environment variables are correctly exported and available within the shell session. Check the `env` output for all relevant variables and ensure no typos or naming mismatches.
- **Deployment Strategy Failure**:
  - *Symptom*: Rollout strategy does not start correctly, and the deployment process blocks.
  - *Solution*: Ensure the Cloud Foundry CLI is updated to a version that supports the `rolling` strategy. Additionally, verify that the application is configured with enough resources to handle both old and new instances simultaneously.
- **Network Policy Errors**:
  - *Symptom*: Rules do not get added to Cloud Foundry, and the system complains about incorrect parameters or permissions.
  - *Solution*: Double-check the naming conventions of `APP_NAME`, `WAF_NAME`, `PROJECT`, and the environment space. Validate the availability of the referenced services and correct any parameter issues or missing permissions.
- **Routing Errors**:
  - *Symptom*: The route mapping fails (cf map-route commands).
  - *Solution*: Check the `WAF_NAME`, `CMS_FQDN`, and `STATIC_FQDN` variables to ensure they are correctly defined and the domains are accessible from the cloud.gov platform.

#### Logging and Diagnostics

- **Logs**: Check the logs generated by the failed command. Logs provide insights into where the deployment process faltered and can guide you towards troubleshooting steps. 
- **Debugging**: Add -x to the cloud-gov-deploy.sh command to enable detailed logging for each executed command. This can aid in identifying which step failed and why. 
     
